name: Android Build

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Decode Google Services JSON
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          if [ -n "$GOOGLE_SERVICES_JSON" ]; then
            echo "$GOOGLE_SERVICES_JSON" | base64 --decode > app/google-services.json
          else
            echo "Warning: GOOGLE_SERVICES_JSON secret not found. Creating dummy file."
            cat <<EOT > app/google-services.json
          {
            "project_info": {
              "project_number": "123456789012",
              "project_id": "dummy-project-id",
              "storage_bucket": "dummy-project-id.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:123456789012:android:0000000000000000",
                  "android_client_info": {
                    "package_name": "ee.ria.DigiDoc.debug"
                  }
                },
                "oauth_client": [],
                "api_key": [
                  {
                    "current_key": "dummy-api-key"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": []
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOT
          fi

      - name: Setup Debug Keystore
        run: |
          mkdir -p app/src/main/assets/keystore
          keytool -genkeypair -v -keystore app/src/main/assets/keystore/debug.keystore \
            -storepass android -keypass android \
            -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Debug,O=Debug,C=EE"

      - name: Setup Config and TSL Files
        run: |
          CONFIG_DIR=config-lib/src/main/assets/config
          TSL_FILES_DIR=config-lib/src/main/assets/tslFiles
          mkdir -p $CONFIG_DIR
          mkdir -p $TSL_FILES_DIR

          # Download files
          echo "Downloading eu-lotl.xml..."
          wget "https://ec.europa.eu/tools/lotl/eu-lotl.xml" -O $TSL_FILES_DIR/eu-lotl.xml
          echo "Downloading tl-mp-test-EE.xml..."
          wget "https://open-eid.github.io/test-TL/tl-mp-test-EE.xml" -O $TSL_FILES_DIR/tl-mp-test-EE.xml

          # Run downloader script
          echo "Running TSLXMLDownloader.py..."
          python3 scripts/TSLXMLDownloader.py \
            --tslFile="$TSL_FILES_DIR/eu-lotl.xml" \
            --tslTestFile="$TSL_FILES_DIR/tl-mp-test-EE.xml" \
            --countries="EE;EE_T" \
            --isDevBuild="True"

          # Move TSLs
          echo "Moving TSL files..."
          mv -v scripts/TSL/* $TSL_FILES_DIR/ || true

      - name: Make Gradlew Executable
        run: chmod +x gradlew

      - name: Fetch Default Configuration
        run: |
          ./gradlew clean --no-daemon fetchAndPackageDefaultConfiguration \
            --args="https://id-test.eesti.ee 4" \
            -Dorg.gradle.jvmargs="-Xmx4g"

      - name: Update Version Code
        run: |
          sed -i "s/versionCode = \".*\"/versionCode = \"$GITHUB_RUN_NUMBER\"/" gradle/libs.versions.toml

      - name: Build Debug APK
        run: ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk

  notify:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        if: ${{ secrets.MAIL_TO }} != ''
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: Android Build Ready - ${{ github.repository }}
          body: |
            The Android build for ${{ github.repository }} is complete.

            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}

            You can download the APK artifact from the workflow run page:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            (Check the 'Artifacts' section at the bottom)
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
